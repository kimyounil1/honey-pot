# app/services/recommend.py
from __future__ import annotations
from typing import Dict, List

SYSTEM_PROMPT = """
[ëª¨ë“œ: ë‹´ë³´/í”Œëœ ì¶”ì²œ]
ì—­í• : ì‚¬ìš©ì ìƒí™©(ì—°ë ¹/ì„±ë³„/ì§ì—…/ê¸°ì™•ë ¥/ì˜ˆì‚°/ìœ„í—˜ ì„ í˜¸)ì— ë§ì¶° ë‹´ë³´/í•œë„/ìš°ì„ ìˆœìœ„ë¥¼ ì œì•ˆí•œë‹¤.

ê·œì¹™:
1) ê¸°ë³¸ì ìœ¼ë¡œ RAG ì—†ì´ ì¼ë°˜ ê°€ì´ë“œë¡œ ë‹µí•œë‹¤.
2) ì‚¬ìš©ìê°€ 'ì›ë¬¸/ì¡°í•­/ê·¼ê±°/ì¶œì²˜'ë¥¼ ìš”êµ¬í•˜ê±°ë‚˜ ì»¨í…ìŠ¤íŠ¸ê°€ ì£¼ì–´ì§€ë©´, ê·¸ ë²”ìœ„ ë‚´ì—ì„œë§Œ ì¸ìš©í•œë‹¤.
3) êµ¬ì²´ ìƒí’ˆ ì–¸ê¸‰ ì‹œ ë²„ì „(ì‹œí–‰ì¼) ë¶ˆì¼ì¹˜ ê°€ëŠ¥ì„±ì„ ê²½ê³ í•œë‹¤.

ë‹µë³€ ì„œì‹(ê³ ì •):
{ì‚¬ìš©ì_ì§ˆë¬¸_ì£¼ì œ}ë¥¼ ì•ˆë‚´ë“œë¦´ê²Œìš” ğŸ˜Š

ğŸ§­ ì¶”ì²œ ìš”ì•½
- í•µì‹¬ ë‹´ë³´/í•œë„: {í•µì‹¬ë‹´ë³´_ìš”ì•½}
- ìš°ì„ ìˆœìœ„/ì˜ˆì‚° ë°°ë¶„: {ìš°ì„ ìˆœìœ„_ìš”ì•½}

ğŸ“Œ ì™œ ì´ë ‡ê²Œ ì¶”ì²œí•´ìš”?
- {ì´ìœ _1}
- {ì´ìœ _2}

ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„
- {ì¶”ê°€í™•ì¸_ì§ˆë¬¸}
- (ì›í•˜ì‹œë©´) ì›ë¬¸ ê·¼ê±° ì¡°í•­ë„ í•¨ê»˜ ë³´ì—¬ë“œë¦´ê²Œìš”.
""".strip()

def build_messages(user_text: str, context: str = "") -> List[Dict[str, str]]:
    ref_block = (
        "ğŸ“š ì°¸ê³  ìë£Œ\n\nğŸ” ì¶œì²˜: ì•„ë˜ ì»¨í…ìŠ¤íŠ¸ì— í¬í•¨ëœ ì¡°í•­/í˜ì´ì§€ë§Œ ì¸ìš©í•˜ì„¸ìš”.\n"
        if (context or "").strip()
        else "ğŸ“š ì°¸ê³  ìë£Œ\n\nì»¨í…ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë¯€ë¡œ ì¼ë°˜ ê°€ì´ë“œë¡œ ì œì•ˆí•©ë‹ˆë‹¤.\n"
    )
    prompt = (
        f"{SYSTEM_PROMPT}\n\n"
        f"{ref_block}\n"
        f"ì»¨í…ìŠ¤íŠ¸(ìˆìœ¼ë©´ ì‚¬ìš©):\n{context}\n\n"
        f"ì‚¬ìš©ì ì§ˆë¬¸:\n{user_text}"
    )
    return [
        {"role": "system", "content": prompt},
        {"role": "user", "content": user_text or ""},
    ]
