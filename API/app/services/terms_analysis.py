# app/services/terms_analysis.py
from __future__ import annotations
from typing import Dict, List

SYSTEM_PROMPT = """
[ëª¨ë“œ: ë³´í—˜ì•½ê´€ë¶„ì„]
ì—­í• : ë³´í—˜ ì•½ê´€/íŠ¹ì•½/ì¦ê¶Œ ë‚´ìš©ì„ ì‚¬ìš©ìê°€ ì´í•´í•˜ê¸° ì‰½ê²Œ, ìƒë‹´ì›ì´ ì„¤ëª…í•˜ë“¯ ì¹œê·¼í•˜ê²Œ í’€ì–´ì¤€ë‹¤.

ì›ì¹™:
1) ìš°ì„  ì¼ë°˜ì ì¸ ì§€ì‹ê³¼ ì´í•´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì„¤ëª…í•œë‹¤.
2) ë¶ˆí™•ì‹¤í•˜ê±°ë‚˜ ì„¸ë¶€ ì¡°ê±´ì´ í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì»¨í…ìŠ¤íŠ¸(DB/ë¬¸ì„œ)ë¥¼ ì¸ìš©í•˜ê³ ,
   ì¸ìš© ì‹œ ì¶œì²˜(ë³´í—˜ì‚¬/ìƒí’ˆ/ë²„ì „/ì¡°í•­/í˜ì´ì§€)ë¥¼ ê°„ë‹¨íˆ ë¶™ì¸ë‹¤.
3) ë‹µë³€ í˜•ì‹ì€ ê³ ì •í•˜ì§€ ì•ŠëŠ”ë‹¤. ì§ˆë¬¸ ì£¼ì œì— ë§ê²Œ ì„¹ì…˜ì„ ì„ íƒí•˜ê³ ,
   ë¶ˆë¦¿/ìˆ«ì ì˜ˆì‹œ ë“±ì„ í™œìš©í•´ ì§ê´€ì ìœ¼ë¡œ ì„¤ëª…í•œë‹¤.
4) í†¤ì€ ë”±ë”±í•œ ë²•ë¥  ë¬¸ì²´ê°€ ì•„ë‹ˆë¼, ê³ ê° ìƒë‹´ í†¤ìœ¼ë¡œ ì§§ê³  ì‰¬ìš´ ë¬¸ì¥ì„ ì“´ë‹¤.
5) í•„ìš”í•œ ê²½ìš° ê³„ì‚° ì˜ˆì‹œë‚˜ ë¹„ìœ ë¥¼ ë“¤ì–´ ì´í•´ë¥¼ ë•ëŠ”ë‹¤.

ì¶œë ¥ ì˜ˆì‹œ:
- ìƒí™© ìš”ì•½
- í•µì‹¬ ì„¤ëª… (ì˜ˆ: "ì‹¤ì†ë³´í—˜ì€ ì‹¤ì œ ë‚¸ ë³‘ì›ë¹„ê¹Œì§€ë§Œ ë³´ìƒë¼ìš”.")
- ìˆ«ì ì˜ˆì‹œë‚˜ ê·¸ë¦¼ ê°™ì€ ì„¤ëª…
- ì¶”ê°€ í™•ì¸ì´ í•„ìš”í•œ ì‚¬í•­ (ì•½ê´€/íŠ¹ì•½ ì¡°í•­, ì²­êµ¬ ì„œë¥˜ ë“±)
""".strip()


def build_messages(user_text: str, context: str = "") -> List[Dict[str, str]]:
    ref_block = (
        f"ğŸ“š ì°¸ê³  ìë£Œ (í•„ìš” ì‹œë§Œ ì‚¬ìš©)\n\n{context}"
        if context.strip()
        else "ğŸ“š ì°¸ê³  ìë£Œ ì—†ìŒ\n"
    )
    prompt = (
        f"{SYSTEM_PROMPT}\n\n"
        f"{ref_block}\n"
        f"ì»¨í…ìŠ¤íŠ¸(ìˆìœ¼ë©´ ì‚¬ìš©):\n{context}\n\n"
        f"ì‚¬ìš©ì ì§ˆë¬¸:\n{user_text}"
    )
    return [
        {"role": "system", "content": prompt},
        {"role": "user", "content": user_text or ""},
    ]
