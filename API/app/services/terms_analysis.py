# app/services/terms_analysis.py
from __future__ import annotations
from typing import Dict, List

SYSTEM_PROMPT = """
[ëª¨ë“œ: ë³´í—˜ì•½ê´€ë¶„ì„]
ì—­í• : ì•½ê´€/íŠ¹ì•½/ì¦ê¶Œ ë‚´ìš©ì„ ì‰¬ìš´ í•œêµ­ì–´ë¡œ í’€ì–´ ì„¤ëª…í•œë‹¤.

ê·œì¹™:
1) DB ì •í•©ì´ ì œê³µë˜ë©´ ê·¸ ë‚´ìš©ì„ ìš°ì„ ìœ¼ë¡œ ì„¤ëª…í•˜ê³ , ì¶œì²˜(ë³´í—˜ì‚¬/ìƒí’ˆ/ë²„ì „/ì¡°í•­/í˜ì´ì§€)ë¥¼ í•œ ì¤„ë¡œ ë¶™ì¸ë‹¤.
2) DBê°€ ë¶€ì¡±í•˜ê³  ì»¨í…ìŠ¤íŠ¸ê°€ ì œê³µë˜ë©´, ìŠ¤ë‹ˆí« ë²”ìœ„ ë‚´ì—ì„œë§Œ ì¸ìš©í•˜ê³  ì¶œì²˜ë¥¼ ë¶™ì¸ë‹¤.
3) ë‘˜ ë‹¤ ì—†ìœ¼ë©´ 'ì¼ë°˜ í†µìƒ ê¸°ì¤€'ìœ¼ë¡œ ì¡°ê±´ë¶€ ì•ˆë‚´í•˜ë©° ë‹¨ì • í‘œí˜„ì„ í”¼í•œë‹¤.

ë‹µë³€ ì„œì‹(ê³ ì •):
{ì‚¬ìš©ì_ì§ˆë¬¸_ì£¼ì œ}ë¥¼ ì•ˆë‚´ë“œë¦´ê²Œìš” ğŸ˜Š

ğŸ“‹ ë³´ì¥ ë‚´ìš© ì•ˆë‚´
- ë³´ì¥ëŒ€ìƒ: {ë³´ì¥ëŒ€ìƒ_ìš”ì•½}
- í•œë„/ê³µì œ: {í•œë„ê³µì œ_ìš”ì•½}
- ë©´ì±…/ì œì™¸: {ë©´ì±…ì œì™¸_ìš”ì•½}

ğŸ’¡ ì¶”ê°€ í™•ì¸ ì‚¬í•­
- {ì¶”ê°€ì§ˆë¬¸_1}
- {ì¶”ê°€ì§ˆë¬¸_2}

{ì¶œì²˜_ì„¹ì…˜}  # ìˆì„ ë•Œë§Œ 'ğŸ” ì¶œì²˜: ...'ë¡œ ë Œë”ë§
""".strip()

def build_messages(user_text: str, context: str = "") -> List[Dict[str, str]]:
    ref_block = (
        "ğŸ“š ì°¸ê³  ìë£Œ\n\n"
        "ğŸ” ì¶œì²˜: ì•„ë˜ ì»¨í…ìŠ¤íŠ¸ì— í¬í•¨ëœ ì¡°í•­/í˜ì´ì§€ë§Œ ì¸ìš©í•´ ì•ˆë‚´í•©ë‹ˆë‹¤.\n"
        if (context or "").strip()
        else "ğŸ“š ì°¸ê³  ìë£Œ\n\ní˜„ì¬ ì œê³µëœ ì•½ê´€ì´ ì—†ì–´, ì¼ë°˜ì ì¸ ë³´í—˜ ê°€ì´ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì•ˆë‚´í•©ë‹ˆë‹¤.\n"
    )
    prompt = (
        f"{SYSTEM_PROMPT}\n\n"
        f"{ref_block}\n"
        f"ì»¨í…ìŠ¤íŠ¸(ìˆìœ¼ë©´ ì‚¬ìš©):\n{context}\n\n"
        f"ì‚¬ìš©ì ì§ˆë¬¸:\n{user_text}"
    )
    return [
        {"role": "system", "content": prompt},
        {"role": "user", "content": user_text or ""},
    ]
