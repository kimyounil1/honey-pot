# app/services/terms_analysis.py
from typing import List, Dict

# ì²­êµ¬ ì˜ë„ ê°ì§€ í‚¤ì›Œë“œ(í•„ìš”ì‹œ ì¶”ê°€)
CLAIM_KEYWORDS = {
    "ì²­êµ¬", "ì„œë¥˜", "ì ‘ìˆ˜", "ì œì¶œ", "í•„ìš”ì„œë¥˜",
    "ì§€ê¸‰", "ë³´ìƒ", "ì‹ ì²­", "ì˜ìˆ˜ì¦", "ì‹¬ì‚¬", "ì²­êµ¬ë°©ë²•", "ì²­êµ¬ê¸°ê°„", "claim"
}

def _has_claim_intent(text: str) -> bool:
    """ì‚¬ìš©ì ì§ˆë¬¸ì—ì„œ ì²­êµ¬ ê´€ë ¨ ì˜ë„ë¥¼ ê°„ë‹¨íˆ ê°ì§€"""
    t = (text or "").replace(" ", "")
    return any(k in t for k in CLAIM_KEYWORDS)

# ê³µí†µ ë² ì´ìŠ¤ í”„ë¡¬í”„íŠ¸(ì²­êµ¬ ì„¹ì…˜ì€ {CLAIM_BLOCK} ìë¦¬ë¡œ ë¶„ê¸° ì£¼ì…)
SYSTEM_PROMPT_BASE = (
    "[ëª¨ë“œ: ë³´í—˜ì•½ê´€ë¶„ì„]\n"
    "ì—­í• : ì•½ê´€/íŠ¹ì•½/ì¦ê¶Œ ë‚´ìš©ì„ ì´í•´í•˜ê¸° ì‰½ê²Œ í’€ì–´ì„œ ì•ˆë‚´í•˜ê³ , ì•½ê´€ ì—¬ë¶€ì— ë”°ë¼ ì¶”ê°€ ì§ˆë¬¸ì„ ë§ë¶™ì¸ë‹¤.\n"
    "\n"
    "ë‹µë³€ í˜•ì‹(ê³ ì •):\n"
    "ì‹¤ì†ë³´í—˜ì—ì„œ {ì‚¬ìš©ì_ì§ˆë¬¸_ì£¼ì œ}ë¥¼ ì•ˆë‚´ë“œë¦´ê²Œìš” ğŸ˜Š\n"
    "\n"
    "ğŸ“‹ ë³´ì¥ ë‚´ìš© ì•ˆë‚´\n"
    "\n"
    "ë³´ì¥ëŒ€ìƒ: {ë³´ì¥ëŒ€ìƒ_ìš”ì•½}  \n"
    "í•œë„/ê³µì œ: {í•œë„ê³µì œ_ìš”ì•½}  \n"
    "ë©´ì±…/ì œì™¸: {ë©´ì±…ì œì™¸_ìš”ì•½}\n"
    "\n"
    "{CLAIM_BLOCK}"
    "ğŸ“š ì°¸ê³  ìë£Œ\n"
    "\n"
    "í˜„ì¬ ì œê³µëœ ì•½ê´€ì´ ì—†ì–´, ì¼ë°˜ì ì¸ ë³´í—˜ ê°€ì´ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì•ˆë‚´ë“œë ¸ìŠµë‹ˆë‹¤.\n"
    "\n"
    "ğŸ“Œ ìš”ì•½\n"
    "\n"
    "{í•µì‹¬_ìš”ì•½_1ì¤„}\n"
    "\n"
    "- ì‚¬ìš©ìê°€ ë³´í—˜ì‚¬ëª…, ë³´í—˜ìƒí’ˆëª… ë˜ëŠ” ì§„ë‹¨ì„œë¥¼ ì´ë¯¸ ì œê³µí•œ ê²½ìš° ì•„ë˜ ë¬¸êµ¬ëŠ” ìƒëµ.\n"
    "- ì œê³µí•˜ì§€ ì•Šì•˜ë‹¤ë©´ í•­ìƒ ë§ˆì§€ë§‰ì— ì¶”ê°€:\n"
    "  'í˜¹ì‹œ ê°€ì…í•˜ì‹  ë³´í—˜ì‚¬ì™€ ìƒí’ˆëª…ì„ ì•Œë ¤ì£¼ì‹œê² ì–´ìš”?'\n"
    "  'ì§„ë‹¨ì„œë¥¼ ì—…ë¡œë“œí•´ ì£¼ì‹œë©´ ë” ì •í™•í•˜ê²Œ ì•ˆë‚´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤ !ğŸ¯'\n"
    "\n"
    "ì‘ì„± ê·œì¹™:\n"
    "- ë‹µë³€ì€ í•œêµ­ì–´.\n"
    "- ê° ì œëª© í›„ ë°˜ë“œì‹œ ì¤„ë°”ê¿ˆ.\n"
    "- í‘œ ëŒ€ì‹  ë¬¸ì¥ê³¼ ì¤„ë°”ê¿ˆ ìœ„ì£¼ë¡œ êµ¬ì„±.\n"
    "- ì¹œê·¼í•œ ìƒë‹´ í†¤ ìœ ì§€.\n"
    "- ìˆ«ì/ì¡°ê±´ì€ ì»¨í…ìŠ¤íŠ¸ì— ìˆì„ ë•Œë§Œ ëª…ì‹œ(ì„ì˜ ì¶”ì • ê¸ˆì§€). ì»¨í…ìŠ¤íŠ¸ ì—†ìœ¼ë©´ ì›ì¹™ ìœ„ì£¼ë¡œ ì„¤ëª….\n"
    "- ì§ˆë¬¸ ì£¼ì œì™€ ë¬´ê´€í•œ ì˜ˆì‹œ(ì˜ˆ: ë„ìˆ˜ì¹˜ë£Œ ë“±)ë¥¼ í•˜ë“œì½”ë”©í•˜ì§€ ë§ ê²ƒ.\n"
)

# ì²­êµ¬ ì„¹ì…˜ ë¸”ë¡(ì˜ë„ ìˆì„ ë•Œë§Œ ì‚½ì…)
CLAIM_BLOCK = (
    "ğŸ’µ ì²­êµ¬ ì•ˆë‚´\n"
    "\n"
    "í•„ìš”í•œ ì„œë¥˜: {ì²­êµ¬_ì„œë¥˜_ìš”ì•½}  \n"
    "ì²­êµ¬ ì ˆì°¨: {ì²­êµ¬_ì ˆì°¨_ìš”ì•½}  \n"
    "ì²­êµ¬ ê°€ëŠ¥ ê¸°ê°„: {ì²­êµ¬_ê¸°ê°„_ìš”ì•½}\n"
    "\n"
)

def _build_system_prompt(include_claim: bool) -> str:
    """ì²­êµ¬ ì„¹ì…˜ í¬í•¨ ì—¬ë¶€ì— ë”°ë¼ SYSTEM_PROMPT ì™„ì„±"""
    claim_text = CLAIM_BLOCK if include_claim else ""
    return SYSTEM_PROMPT_BASE.replace("{CLAIM_BLOCK}", claim_text)

def build_messages(user_text: str, context: str = "") -> List[Dict[str, str]]:
    include_claim = _has_claim_intent(user_text)
    SYSTEM_PROMPT = _build_system_prompt(include_claim)

    prompt = (
        f"{SYSTEM_PROMPT}\n\n"
        f"ì»¨í…ìŠ¤íŠ¸(ê²€ìƒ‰ê²°ê³¼ê°€ ìˆìœ¼ë©´ ë°˜ì˜):\n{context}\n\n"
        f"ì‚¬ìš©ì ì§ˆë¬¸:\n{user_text}"
    )
    return [
        {
            "role": "system",
            "content": (
                "ë„ˆëŠ” í•œêµ­ ì‚¬ìš©ìì—ê²Œ ë³´í—˜ì„ ì‰½ê²Œ, ì¹œê·¼í•œ ìƒë‹´ í†¤ìœ¼ë¡œ ì•ˆë‚´í•˜ëŠ” ë³´ì¡°ìë‹¤. "
                "í‘œ ëŒ€ì‹  ì¤„ë°”ê¿ˆê³¼ í•œ ì¤„ ì„¤ëª…ìœ¼ë¡œ ì‘ì„±í•œë‹¤."
            ),
        },
        {"role": "user", "content": prompt},
    ]
