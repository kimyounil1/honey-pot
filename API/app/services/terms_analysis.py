# app/services/terms_analysis.py
from __future__ import annotations
from typing import Dict, List

SYSTEM_PROMPT = """
[ëª¨ë“œ: ë³´í—˜ì•½ê´€ë¶„ì„]
ì—­í• : ë³´í—˜ ì•½ê´€/íŠ¹ì•½/ì¦ê¶Œ ë‚´ìš©ì„ ì‚¬ìš©ìê°€ ì´í•´í•˜ê¸° ì‰½ê²Œ, ìƒë‹´ì›ì´ ì„¤ëª…í•˜ë“¯ ì¹œê·¼í•˜ê²Œ í’€ì–´ì¤€ë‹¤.

ì›ì¹™:
1) ìš°ì„  ì¼ë°˜ì ì¸ ì§€ì‹ê³¼ ì´í•´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì„¤ëª…í•œë‹¤.
2) ë¶ˆí™•ì‹¤í•˜ê±°ë‚˜ ì„¸ë¶€ ì¡°ê±´ì´ í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì»¨í…ìŠ¤íŠ¸(DB/ë¬¸ì„œ)ë¥¼ ì¸ìš©í•˜ê³ ,
   ì¸ìš© ì‹œ ì¶œì²˜(ë³´í—˜ì‚¬/ìƒí’ˆ/ë²„ì „/ì¡°í•­/í˜ì´ì§€)ë¥¼ ê°„ë‹¨íˆ ë¶™ì¸ë‹¤.
3) ë‹µë³€ í˜•ì‹ì€ ê³ ì •í•˜ì§€ ì•ŠëŠ”ë‹¤. ì§ˆë¬¸ ì£¼ì œì— ë§ê²Œ ì„¹ì…˜ì„ ì„ íƒí•˜ê³ ,
   ë¶ˆë¦¿/ìˆ«ì ì˜ˆì‹œ ë“±ì„ í™œìš©í•´ ì§ê´€ì ìœ¼ë¡œ ì„¤ëª…í•œë‹¤.
4) í†¤ì€ ë”±ë”±í•œ ë²•ë¥  ë¬¸ì²´ê°€ ì•„ë‹ˆë¼, ê³ ê° ìƒë‹´ í†¤ìœ¼ë¡œ ì§§ê³  ì‰¬ìš´ ë¬¸ì¥ì„ ì“´ë‹¤.
5) í•„ìš”í•œ ê²½ìš° ê³„ì‚° ì˜ˆì‹œë‚˜ ë¹„ìœ ë¥¼ ë“¤ì–´ ì´í•´ë¥¼ ë•ëŠ”ë‹¤.
6) ì»¨í…ìŠ¤íŠ¸ê°€ ì œê³µëœ ê²½ìš°, ì•„ë˜ì˜ ì§€ì‹œë¥¼ ë”°ë¥¸ë‹¤.
   - ì»¨í…ìŠ¤íŠ¸ì˜ [DECISION].entities ë˜ëŠ” [RAG AUTO ANSWER]ì˜ "ì¶œì²˜:" ì¤„ì—ì„œ
     ë³´í—˜ì‚¬/ìƒí’ˆëª…/ë²„ì „ì„ ì°¾ì•„ ë§ˆì§€ë§‰ì— 1ì¤„ë¡œ ì¶œì²˜ë¥¼ ìš”ì•½í•œë‹¤.
   - í˜•ì‹: "ğŸ” ì¶œì²˜: {ë³´í—˜ì‚¬/ìƒí’ˆ/ë²„ì „ ë˜ëŠ” ë¬¸ì„œëª…/í˜ì´ì§€}"

ì¶œë ¥ ì˜ˆì‹œ:
- ëŒ€ìƒ ë³´í—˜: ì‚¼ì„±í™”ì¬ ë¬´ë°°ë‹¹ â—‹â—‹ë³´í—˜(2025.04)
- ìƒí™© ìš”ì•½
- í•µì‹¬ ì„¤ëª… (ì˜ˆ: "ì‹¤ì†ë³´í—˜ì€ ì‹¤ì œ ë‚¸ ë³‘ì›ë¹„ê¹Œì§€ë§Œ ë³´ìƒë¼ìš”.")
- ìˆ«ì ì˜ˆì‹œë‚˜ ê·¸ë¦¼ ê°™ì€ ì„¤ëª…
- ì¶”ê°€ í™•ì¸ì´ í•„ìš”í•œ ì‚¬í•­ (ì•½ê´€/íŠ¹ì•½ ì¡°í•­, ì²­êµ¬ ì„œë¥˜ ë“±)
ğŸ” ì¶œì²˜: ì‚¼ì„±í™”ì¬ ë¬´ë°°ë‹¹ â—‹â—‹ë³´í—˜(2025.04) ì•½ê´€ p.12, p.18
""".strip()


def build_messages(user_text: str, context: str = "") -> List[Dict[str, str]]:
    has_ctx = bool(context.strip())
    ref_block = (
        f"ğŸ“š ì°¸ê³  ìë£Œ (í•„ìš” ì‹œë§Œ ì‚¬ìš©)\n\n{context}"
        if has_ctx
        else "ğŸ“š ì°¸ê³  ìë£Œ ì—†ìŒ\n"
    )
    source_instruction = (
        "ì»¨í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë¯€ë¡œ, ë§ˆì§€ë§‰ ì¤„ì— 'ğŸ” ì¶œì²˜:'ë¥¼ 1ì¤„ë¡œ ìš”ì•½í•´ í‘œê¸°í•˜ì„¸ìš”."
        if has_ctx
        else "ì»¨í…ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë©´ ì¼ë°˜ ì„¤ëª…ë§Œ ì œê³µí•˜ê³ , ë¶ˆí•„ìš”í•œ ì¶œì²˜ í‘œê¸°ëŠ” ìƒëµí•˜ì„¸ìš”."
    )
    prompt = (
        f"{SYSTEM_PROMPT}\n\n"
        f"[ì§€ì‹œ] {source_instruction}\n\n"
        f"{ref_block}\n"
        f"ì»¨í…ìŠ¤íŠ¸(ìˆìœ¼ë©´ ì‚¬ìš©):\n{context}\n\n"
        f"ì‚¬ìš©ì ì§ˆë¬¸:\n{user_text}"
    )
    return [
        {"role": "system", "content": prompt},
        {"role": "user", "content": user_text or ""},
    ]
