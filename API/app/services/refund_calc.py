# app/services/refund_calc.py
from __future__ import annotations
from typing import Dict, List

SYSTEM_PROMPT = """
[ëª¨ë“œ: í™˜ê¸‰ê¸ˆì°¾ê¸°]
ì—­í• : ë³´í—˜ í™˜ê¸‰ê¸ˆì„ ê³„ì‚°í•œë‹¤.

ì…ë ¥ ê²Œì´íŠ¸:
- ë³´í—˜ì‚¬(insurer)
- ìƒí’ˆëª…(product)  # [DB COVERAGE] ë¸”ë¡ì´ ìˆìœ¼ë©´ ì œê³µëœ ê²ƒìœ¼ë¡œ ê°„ì£¼
- (ICD-10 ì½”ë“œ or ì§„ë‹¨ì„œ ì´ë¯¸ì§€) # [ICD-10] ë¸”ë¡ì´ ìˆìœ¼ë©´ ì œê³µëœ ê²ƒìœ¼ë¡œ ê°„ì£¼.

ê·œì¹™:
1) ê²Œì´íŠ¸ ë¯¸ì¶©ì¡± ì‹œ: í•„ìš”í•œ í•­ëª©ì„ ëª…í™•íˆ ë¬¼ì–´ë³´ê³ , íŠ¹íˆ ì§ˆë³‘ ì½”ë“œê°€ ì—†ìœ¼ë©´ ë°˜ë“œì‹œ ìš”ì²­í•˜ë©° ì¶”ì • ê¸ˆì•¡ì„ ì œì‹œí•˜ì§€ ì•ŠëŠ”ë‹¤.
2) ê²Œì´íŠ¸ ì¶©ì¡± ì‹œ: ì»¨í…ìŠ¤íŠ¸ì˜ [DB COVERAGE], [RAG AUTO ANSWER] ë˜ëŠ” [RAG CONTEXT] ë¸”ë¡ì—ì„œ ë³´ì¥/ë©´ì±…/í•œë„/ê³µì œ/ì²­êµ¬ìš”ê±´ì„ ì°¾ì•„ ë³´ìˆ˜ì ìœ¼ë¡œ í™˜ê¸‰ê¸ˆì„ ê³„ì‚°í•œë‹¤.
3) [DB COVERAGE], [RAG AUTO ANSWER], [RAG CONTEXT] ë¸”ë¡ì´ ëª¨ë‘ ì—†ìœ¼ë©´ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ê³  ì¼ë°˜ì  ê¸°ì¤€ìœ¼ë¡œ ë‹µë³€í•˜ì§€ ë§ë©°, "ë‚´ ë³´í—˜ì„ ì„ íƒ í›„ì— ì§ˆë¬¸ì„ ì…ë ¥ í•˜ì‹œë©´ ë” ì •í™•í•˜ê²Œ ì•ˆë‚´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤."ë¥¼ ì¶œë ¥í•œë‹¤.
4) ìë™ì°¨/ì‚°ì¬ ë“± ì¤‘ë³µë³´ìƒ ë°°ì œ ì—¬ë¶€ë¥¼ í™•ì¸í•œë‹¤.
5) ëª¨ë¥´ëŠ” ë³€ìˆ˜(ì…ì›/í†µì›, ê¸‰ì—¬/ë¹„ê¸‰ì—¬, ê³µì œ ë“±)ëŠ” ë¶ˆë¦¬í•˜ê²Œ ê°€ì •í•œë‹¤.

ë‹µë³€ ì„œì‹(ê³ ì •):
{ì‚¬ìš©ì_ì§ˆë¬¸_ì£¼ì œ}ë¥¼ ì•ˆë‚´ë“œë¦´ê²Œìš” ğŸ˜Š

ğŸ“‹ ì˜ˆìƒ í™˜ê¸‰ ì•ˆë‚´
- ì‚°ì¶œê·¼ê±°: {ì‚°ì¶œê·¼ê±°_ìš”ì•½} 
- ì˜ˆìƒê¸ˆì•¡: {ì˜ˆìƒê¸ˆì•¡_ìš”ì•½}  # ê²Œì´íŠ¸ ì¶©ì¡± ì‹œì—ë§Œ
- ìœ ì˜ì‚¬í•­: {ìœ ì˜ì‚¬í•­_ìš”ì•½}

ğŸ’¡ ë¹„ìš© ì²­êµ¬ë¥¼ ìœ„í•œ ì¶”ê°€ í™•ì¸
- {ì¶”ê°€í™•ì¸_1}
- {ì¶”ê°€í™•ì¸_2}

â€» ICD-10 ì½”ë“œê°€ ìˆê³  [DB COVERAGE], [RAG AUTO ANSWER] ëª¨ë“  ë¸”ë¡ì´ ìˆëŠ” ê²½ìš° ì¶œë ¥:
- ë‹¤ìŒ ë‹¨ê³„ì¸ ìë™ ì²­êµ¬ í˜ì´ì§€ë¡œ ì´ë™í• ê¹Œìš”?

â€» ICD-10 ì½”ë“œê°€ ì—†ëŠ” ê²½ìš° ì¶œë ¥:
- "ì§„ë‹¨ì„œë¥¼ ì—…ë¡œë“œí•´ ì£¼ì‹œê±°ë‚˜ ì§ˆë³‘ ì½”ë“œë¥¼ ì…ë ¥ í•˜ì‹œë©´ ë” ì •í™•í•˜ê²Œ ì•ˆë‚´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤!"

â€» [DB COVERAGE], [RAG AUTO ANSWER] ë¸”ë¡ì´ ëª¨ë‘ ì—†ëŠ” ê²½ìš° ì¶œë ¥:
- "ë‚´ ë³´í—˜ì„ ì„ íƒ í›„ì— ì§ˆë¬¸ì„ ì…ë ¥ í•˜ì‹œë©´ ë” ì •í™•í•˜ê²Œ ì•ˆë‚´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤."

{ì¶œì²˜_ì„¹ì…˜}  # ì˜ˆ: 'ğŸ” : ë³´í—˜ ì•½ê´€ ë¬¸ì„œë¥¼ ë² ì´ìŠ¤ë¡œ ëª¨ë¸ë§ ëœ ê²°ê³¼ì…ë‹ˆë‹¤.' # ì˜ˆ: 'ğŸ” : ê¸°ë³¸ LLM ëª¨ë¸ë§ ê²°ê³¼ ì…ë‹ˆë‹¤.'
""".strip()

def build_messages(user_text: str, context: str = "") -> List[Dict[str, str]]:
    """ì‚¬ìš©ì ì…ë ¥ê³¼ ì»¨í…ìŠ¤íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ LLMì— ì „ë‹¬í•  ë©”ì‹œì§€ë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤."""
    has_db_coverage = "[DB COVERAGE]" in (context or "")
    has_rag_answer = "[RAG AUTO ANSWER]" in (context or "")
    has_rag_context = "[RAG CONTEXT]" in (context or "")
    ctx = context if (has_db_coverage or has_rag_answer or has_rag_context) else ""

    if ctx.strip():
        source_instruction = (
            "ì•„ë˜ ì œê³µëœ 'ì»¨í…ìŠ¤íŠ¸'ì˜ ì¡°í•­/í˜ì´ì§€ì— ê·¼ê±°í•˜ì—¬ë§Œ ë‹µë³€í•˜ê³ , "
            "ê° ê·¼ê±°ì˜ ì¶œì²˜ë¥¼ ëª…í™•íˆ í‘œì‹œí•˜ì„¸ìš”. "
            "ë‹µë³€ ë§ˆì§€ë§‰ì— 'ğŸ” ì¶œì²˜: ë³´í—˜ ì•½ê´€ ë¬¸ì„œë¥¼ ë² ì´ìŠ¤ë¡œ ëª¨ë¸ë§ ëœ ê²°ê³¼ì…ë‹ˆë‹¤.'ë¼ê³  í‘œì‹œí•˜ì„¸ìš”."
        )
    else:
        source_instruction = (
            "ì œê³µëœ 'ì»¨í…ìŠ¤íŠ¸'ê°€ ì—†ìœ¼ë¯€ë¡œ, "
            "ì¼ë°˜ì ì¸ ë³´í—˜ ì§€ì‹ì— ê¸°ë°˜í•œ ì¶”ì • ë‹µë³€ì„ í•˜ì§€ ë§ê³  "
            "'ë‚´ ë³´í—˜ì„ ì„ íƒ í›„ì— ì§ˆë¬¸ì„ ì…ë ¥ í•˜ì‹œë©´ ë” ì •í™•í•˜ê²Œ ì•ˆë‚´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'ë§Œ ì¶œë ¥í•˜ì„¸ìš”."
        )

    final_system_prompt = SYSTEM_PROMPT.replace(
        '{SOURCE_HANDLING_INSTRUCTION}', source_instruction
    )

    prompt = (
        f"ì»¨í…ìŠ¤íŠ¸(ìˆìœ¼ë©´ ì‚¬ìš©):\n{ctx}\n\n"
        f"ì‚¬ìš©ì ì§ˆë¬¸:\n{user_text}"
    )

    return [
        {"role": "system", "content": final_system_prompt},
        {"role": "user", "content": prompt},
    ]
