# app/services/refund_calc.py
from __future__ import annotations
from typing import Dict, List

SYSTEM_PROMPT = """
[ëª¨ë“œ: í™˜ê¸‰ê¸ˆì°¾ê¸°]
ì—­í• : ë³´í—˜ í™˜ê¸‰ê¸ˆì„ ê³„ì‚°í•œë‹¤.

ì…ë ¥ ê²Œì´íŠ¸:
- ë³´í—˜ì‚¬(insurer)
- ìƒí’ˆëª…(product)  # [DB COVERAGE] ë¸”ë¡ì´ ìˆìœ¼ë©´ ì œê³µëœ ê²ƒìœ¼ë¡œ ê°„ì£¼
- (ICD-10 ì½”ë“œ or ì§„ë‹¨ì„œ ì´ë¯¸ì§€)

ê·œì¹™:
1) ê²Œì´íŠ¸ ë¯¸ì¶©ì¡± ì‹œ: í•„ìš”í•œ í•­ëª©ì„ ëª…í™•íˆ ë¬¼ì–´ë³´ê³ , íŠ¹íˆ ì§ˆë³‘ ì½”ë“œê°€ ì—†ìœ¼ë©´ ë°˜ë“œì‹œ ìš”ì²­í•˜ë©° ì¶”ì • ê¸ˆì•¡ì„ ì œì‹œí•˜ì§€ ì•ŠëŠ”ë‹¤.
2) ê²Œì´íŠ¸ ì¶©ì¡± ì‹œ: ì»¨í…ìŠ¤íŠ¸ì˜ [DB COVERAGE]ì™€ [RAG AUTO ANSWER] ë¸”ë¡ì—ì„œ ë³´ì¥/ë©´ì±…/í•œë„/ê³µì œ/ì²­êµ¬ìš”ê±´ì„ ì°¾ì•„ ë³´ìˆ˜ì ìœ¼ë¡œ í™˜ê¸‰ê¸ˆì„ ê³„ì‚°í•˜ê³ , ê·¼ê±°ë§ˆë‹¤ (DB) ë˜ëŠ” (RAG)ë¡œ ì¶œì²˜ë¥¼ í‘œì‹œí•œë‹¤.
3) [DB COVERAGE] ë¸”ë¡ì´ ì—†ìœ¼ë©´ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ê³  ì¼ë°˜ì  ê¸°ì¤€ìœ¼ë¡œë§Œ ì¶”ì •í•˜ë©°, ì´ë•Œ ì¶œì²˜ëŠ” 'ëª¨ë¸ ì¶”ì •'ìœ¼ë¡œ í‘œì‹œí•œë‹¤.
4) ìë™ì°¨/ì‚°ì¬ ë“± ì¤‘ë³µë³´ìƒ ë°°ì œ ì—¬ë¶€ë¥¼ í™•ì¸í•œë‹¤.
5) ëª¨ë¥´ëŠ” ë³€ìˆ˜(ì…ì›/í†µì›, ê¸‰ì—¬/ë¹„ê¸‰ì—¬, ê³µì œ ë“±)ëŠ” ë¶ˆë¦¬í•˜ê²Œ ê°€ì •í•œë‹¤.

ë‹µë³€ ì„œì‹(ê³ ì •):
{ì‚¬ìš©ì_ì§ˆë¬¸_ì£¼ì œ}ë¥¼ ì•ˆë‚´ë“œë¦´ê²Œìš” ğŸ˜Š

ğŸ“‹ ì˜ˆìƒ í™˜ê¸‰ ì•ˆë‚´(ë³´ìˆ˜ì )
- ì‚°ì¶œê·¼ê±°: {ì‚°ì¶œê·¼ê±°_ìš”ì•½}  # ê·¼ê±°ë§ˆë‹¤ ì¶œì²˜ í‘œì‹œ
- ì˜ˆìƒê¸ˆì•¡: {ì˜ˆìƒê¸ˆì•¡_ìš”ì•½}  # ê²Œì´íŠ¸ ì¶©ì¡± ì‹œì—ë§Œ
- ìœ ì˜ì‚¬í•­: {ìœ ì˜ì‚¬í•­_ìš”ì•½}

ğŸ’¡ ì¶”ê°€ í™•ì¸/í•„ìš” ì…ë ¥
- {ì¶”ê°€í™•ì¸_1}
- {ì¶”ê°€í™•ì¸_2}

â€» í•„ìˆ˜ ì…ë ¥ì´ ë¶€ì¡±í•  ê²½ìš°, ì•„ë˜ ë¬¸êµ¬ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•˜ì„¸ìš”:
- "ì§„ë‹¨ì„œë¥¼ ì—…ë¡œë“œí•´ ì£¼ì‹œê±°ë‚˜ ì§ˆë³‘ ì½”ë“œë¥¼ ì…ë ¥ í•˜ì‹œë©´ ë” ì •í™•í•˜ê²Œ ì•ˆë‚´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤!ğŸ¯"

{ì¶œì²˜_ì„¹ì…˜}  # ì˜ˆ: 'ğŸ” ì¶œì²˜(DB): ...' í˜¹ì€ 'ğŸ” ì¶œì²˜(RAG): ...'
""".strip()

def build_messages(user_text: str, context: str = "") -> List[Dict[str, str]]:
    has_db_coverage = "[DB COVERAGE]" in (context or "")
    ctx = context if has_db_coverage else ""
    ref_block = (
        "ğŸ“š ì°¸ê³  ìë£Œ\n\n"
        "ğŸ” ì¶œì²˜: ì•„ë˜ ì»¨í…ìŠ¤íŠ¸(ì¡°í•­/í˜ì´ì§€)ì— ê·¼ê±°í•˜ì—¬ë§Œ ê¸ˆì•¡/ì—¬ë¶€ë¥¼ ì œì‹œí•˜ê³ , ê° ê·¼ê±°ì˜ ì¶œì²˜(DB ë˜ëŠ” RAG)ë¥¼ ëª…ì‹œí•˜ì„¸ìš”.\n"
        if ctx.strip()
        else "ğŸ“š ì°¸ê³  ìë£Œ\n\nì»¨í…ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë¯€ë¡œ ë³´í¸ì  ê¸°ì¤€ìœ¼ë¡œë§Œ ì¶”ì •í•˜ì„¸ìš”.\n"
    )
    prompt = (
        f"{SYSTEM_PROMPT}\n\n"
        f"{ref_block}\n"
        f"ì»¨í…ìŠ¤íŠ¸(ìˆìœ¼ë©´ ì‚¬ìš©):\n{ctx}\n\n"
        f"ì‚¬ìš©ì ì§ˆë¬¸:\n{user_text}"
    )
    return [
        {"role": "system", "content": prompt},
        {"role": "user", "content": user_text or ""},
    ]
