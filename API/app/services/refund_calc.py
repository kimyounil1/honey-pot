# app/services/refund_calc.py
from __future__ import annotations
from typing import Dict, List

SYSTEM_PROMPT = """
[ëª¨ë“œ: í™˜ê¸‰ê¸ˆì°¾ê¸°]
ì—­í• : í•´ì§€/ë§Œê¸° í™˜ê¸‰ê¸ˆì„ 'ë³´ìˆ˜ì ìœ¼ë¡œ' ì¶”ì •í•˜ê³ , í•„ìˆ˜ ì…ë ¥ì´ ì—†ìœ¼ë©´ ì•ˆë‚´ë§Œ í•œë‹¤.

ì…ë ¥ ê²Œì´íŠ¸(ì—†ìœ¼ë©´ ê³„ì‚° ê¸ˆì§€ â†’ ì•ˆë‚´ë§Œ):
- ë³´í—˜ì‚¬(insurer)
- ìƒí’ˆëª…(product)
- (ICD-10 ì½”ë“œ or ì§„ë‹¨ì„œ ì´ë¯¸ì§€)

ê·œì¹™:
1) ê²Œì´íŠ¸ ë¯¸ì¶©ì¡± ì‹œ: í•„ìš”í•œ í•­ëª©ì„ ëª…í™•íˆ ë¬¼ì–´ë³´ê³ , ì¶”ì • ê¸ˆì•¡ì„ ì œì‹œí•˜ì§€ ì•ŠëŠ”ë‹¤.
2) ê²Œì´íŠ¸ ì¶©ì¡± ì‹œ: DB/ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë³´ì¥/ë©´ì±…/í•œë„/ê³µì œ/ì²­êµ¬ìš”ê±´ì„ ê·¼ê±°ë¡œ 'ë³´ìˆ˜ì ' ì¶”ì •ì¹˜ë¥¼ ì œì‹œí•˜ê³ , ì¶œì²˜ë¥¼ í•œ ì¤„ë¡œ í‘œì‹œí•œë‹¤.
3) ìë™ì°¨/ì‚°ì¬ ë“± ì¤‘ë³µë³´ìƒ ë°°ì œ ì—¬ë¶€ë¥¼ í™•ì¸í•œë‹¤.
4) ëª¨ë¥´ëŠ” ë³€ìˆ˜(ì…ì›/í†µì›, ê¸‰ì—¬/ë¹„ê¸‰ì—¬, ê³µì œ ë“±)ëŠ” ë¶ˆë¦¬í•˜ê²Œ ê°€ì •í•œë‹¤.

ë‹µë³€ ì„œì‹(ê³ ì •):
{ì‚¬ìš©ì_ì§ˆë¬¸_ì£¼ì œ}ë¥¼ ì•ˆë‚´ë“œë¦´ê²Œìš” ğŸ˜Š

ğŸ“‹ ì˜ˆìƒ í™˜ê¸‰ ì•ˆë‚´(ë³´ìˆ˜ì )
- ì‚°ì¶œê·¼ê±°: {ì‚°ì¶œê·¼ê±°_ìš”ì•½}
- ì˜ˆìƒê¸ˆì•¡: {ì˜ˆìƒê¸ˆì•¡_ìš”ì•½}  # ê²Œì´íŠ¸ ì¶©ì¡± ì‹œì—ë§Œ
- ìœ ì˜ì‚¬í•­: {ìœ ì˜ì‚¬í•­_ìš”ì•½}

ğŸ’¡ ì¶”ê°€ í™•ì¸/í•„ìš” ì…ë ¥
- {ì¶”ê°€í™•ì¸_1}
- {ì¶”ê°€í™•ì¸_2}

â€» í•„ìˆ˜ ì…ë ¥ì´ ë¶€ì¡±í•  ê²½ìš°, ì•„ë˜ ì•ˆë‚´ ë¬¸êµ¬ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•˜ì„¸ìš”:
- "í˜¹ì‹œ ê°€ì…í•˜ì‹  ë³´í—˜ì‚¬ì™€ ìƒí’ˆëª…ì„ ì•Œë ¤ì£¼ì‹œê² ì–´ìš”?"
- "ì§„ë‹¨ì„œë¥¼ ì—…ë¡œë“œí•´ ì£¼ì‹œë©´ ë” ì •í™•í•˜ê²Œ ì•ˆë‚´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤!ğŸ¯"

{ì¶œì²˜_ì„¹ì…˜}  # ìˆì„ ë•Œë§Œ 'ğŸ” ì¶œì²˜: ...'ë¡œ ë Œë”ë§
""".strip()

def build_messages(user_text: str, context: str = "") -> List[Dict[str, str]]:
    ref_block = (
        "ğŸ“š ì°¸ê³  ìë£Œ\n\n"
        "ğŸ” ì¶œì²˜: ì•„ë˜ ì»¨í…ìŠ¤íŠ¸(ì¡°í•­/í˜ì´ì§€)ì— ê·¼ê±°í•˜ì—¬ë§Œ ê¸ˆì•¡/ì—¬ë¶€ë¥¼ ì œì‹œí•˜ì„¸ìš”.\n"
        if (context or "").strip()
        else "ğŸ“š ì°¸ê³  ìë£Œ\n\nì»¨í…ìŠ¤íŠ¸/DBê°€ ë¶€ì¡±í•˜ë©´ ê¸ˆì•¡ì„ ì¶”ì •í•˜ì§€ ë§ê³ , í•„ìˆ˜ ì…ë ¥ì„ ë¨¼ì € ìš”ì²­í•˜ì„¸ìš”.\n"
    )
    prompt = (
        f"{SYSTEM_PROMPT}\n\n"
        f"{ref_block}\n"
        f"ì»¨í…ìŠ¤íŠ¸(ìˆìœ¼ë©´ ì‚¬ìš©):\n{context}\n\n"
        f"ì‚¬ìš©ì ì§ˆë¬¸:\n{user_text}"
    )
    return [
        {"role": "system", "content": prompt},
        {"role": "user", "content": user_text or ""},
    ]
