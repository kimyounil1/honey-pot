# app/services/fallback.py
from typing import List, Dict

SYSTEM_PROMPT = (
    "[모드: 예외질문]\n"
    "역할: 보험 외 질문에는 답변하지 않고, 친근하게 본 서비스의 4가지 기능 중 하나로 유도한다.\n"
    "\n"
    "답변 시작 문구(고정):\n"
    "- '안녕하세요 😊 보험 관련 질문만 안내드리고 있어요.'\n"
    "\n"
    "📋 이용 가능 서비스\n"
    "1) 약관 분석: 예) 실손 약관에서 도수치료 보장 범위/면책 안내\n"
    "2) 환급금 찾기: 예) 무해지 상품 해지환급금 보수적 추정\n"
    "3) 보험 추천: 예) 30대 남성 치과/사고 대비 담보/한도 추천\n"
    "4) 일반 질문: 예) 비급여 도수치료 청구 서류 안내\n"
    "\n"
    "📌 요약\n"
    "- 궁금하신 보험 주제에 맞춰 위 네 가지 중 하나로 질문해 주세요.\n"
    "\n"
    "조건부 추가 안내:\n"
    "- 사용자가 보험사명, 보험상품명 또는 진단서를 이미 제공한 경우 아래 문구는 생략.\n"
    "- 제공하지 않았다면 항상 마지막에 추가:\n"
    "  '혹시 가입하신 보험사와 상품명을 알려주시겠어요?'\n"
    "  '진단서를 업로드해 주시면 더 정확하게 안내드릴 수 있습니다 !🍯'\n"
    "\n"
    "작성 규칙:\n"
    "- 답변은 한국어.\n"
    "- 표 대신 문장과 줄바꿈 위주로 구성.\n"
    "- 친근한 상담 톤 유지.\n"
)


def build_messages(user_text: str, context: str = "") -> List[Dict[str, str]]:
    prompt = (
        f"{SYSTEM_PROMPT}\n\n"
        f"컨텍스트(있으면 사용):\n{context}\n\n"
        f"사용자 질문:\n{user_text}"
    )
    return [
        {
            "role": "system",
            "content": "너는 한국 사용자에게 보험을 쉽게, 친근한 상담 톤으로 안내하는 보조자다."
        },
        {"role": "user", "content": prompt},
    ]


# ---- LLM 미사용 폴백(정적) ----
def static_answer(user_text: str) -> dict:
    """
    보험 도메인 외 질문에 대한 정적 응답.
    사용자가 이미 보험사/상품/진단서 정보를 적시한 경우 마지막 두 줄(질문/업로드 유도)을 생략한다.
    """
    text_norm = (user_text or "")
    # 간단 키워드 탐지 (띄어쓰기/변형 최소 보정)
    has_info = any(
        key in text_norm
        for key in ["보험사", "보험 회사", "상품", "상품명", "진단서", "서류 업로드"]
    )

    tail = "" if has_info else (
        "혹시 가입하신 보험사와 상품명을 알려주시겠어요?\n"
        "진단서를 업로드해 주시면 더 정확하게 안내드릴 수 있습니다!🍯\n"
    )

    body = (
        "안녕하세요 😊 보험 관련 질문만 안내드리고 있어요.\n\n"
        "📋 이용 가능 서비스\n"
        "1) 약관 분석\n"
        "   - 실손 약관에서 도수치료 보장 범위/면책 안내\n"
        "   - 특약 조항(○○) 적용 조건 설명\n"
        "2) 환급금 찾기\n"
        "   - 무해지 상품 해지환급금 보수적 추정\n"
        "   - 만기환급금 계산 시 누락 입력 확인\n"
        "3) 보험 추천\n"
        "   - 30대 남성 치과/사고 대비 담보/한도 추천\n"
        "   - 현재 보장 빈틈(갭) 간단 진단\n"
        "4) 일반 질문(청구/서류/절차)\n"
        "   - 비급여 도수치료 청구 서류 안내\n"
        "   - 입원비 청구 시 유의사항\n\n"
        "📌 요약\n"
        "- 위 네 가지 중 하나로 질문을 주시면 빠르게 도와드릴게요.\n\n"
        f"{tail}"
    )
    return {"answer": body}
